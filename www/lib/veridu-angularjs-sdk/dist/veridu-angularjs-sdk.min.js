!function(){"use strict";var e=angular.module("veridu.angularjs.sdk",[]);e.provider("Veridu",function(){var e=function(e,t,i,n,r,o,s,u,c,a){function f(){a.$emit("VeriduLogout",I.profile&&I.profile.user||I.user),I.user={},delete I.profile,delete I.cfg.session,delete I.cfg.user,w.removeItem("cfg"),I.SSO.logout(),p()}function g(){function e(e,t,i){var n=["GET","PUT","POST","DELETE"];return t?-1==n.indexOf(e.toUpperCase())?(u.error("Calling API.fetch with invalid method parameter! ("+e+")"),!1):s({method:e,url:I.Util.apiUrl(t),headers:{"Veridu-Client":I.cfg.client,"Veridu-Session":I.cfg.session},params:i||{},paramSerializer:"$httpParamSerializerJQLike"}):(u.error("Calling API.fetch with invalid resource parameter! ("+t+")"),!1)}this.fetch=e}function d(){function e(){w.removeItem("sso"),a.$emit("VeriduSSOLogout",{cfg:I.cfg,user:I.user}),delete I.SSO.provider,a.$$phase||a.$apply()}function t(e){if(!e)return!1;try{e="string"==typeof e?JSON.parse(e):e,I.SSO.provider=e.veridu_provider,I.user.name=e.veridu_name,I.user.email=e.veridu_email,w.setItem("sso",e),a.$$phase||a.$apply(),a.$emit("VeriduSSOLogin",e)}catch(t){return u.error("Error parsing API response"),!1}}function i(e){I.cfg.session&&u.error("User already signed! Logout if you want to access via another SSO provider"),window.open(I.cfg.URL.widget+"/"+I.cfg.API_VERSION+"/sso/login/"+e+"/"+I.cfg.client+"?language="+I.cfg.lang+"&mobile=true&session="+I.cfg.session+"&nonce=nonce&redirect="+c.location.toString(),"sso","width=500,height=500")}this.login=i,this.logout=e,this.populate=t,c.addEventListener("message",function(e){e.origin==I.cfg.URL.widget&&t(e.data)})}function l(){function e(e){window.open("https://widget.veridu.com/"+I.cfg.API_VERSION+"/provider/login/"+e+"/"+I.cfg.client+"/"+I.cfg.user+"?session="+I.cfg.session+"&amp;language=en-us","_system")}this.login=e}function p(){w.setItem("nonce",I.nonce);var e=w.getItem("cfg");return e?void m(e):(e=w.getItem("sso"))?void I.SSO.populate(e):void I.API.fetch("POST","session/write",{client:I.cfg.client,nonce:I.nonce,mobile:!0,timestamp:1*new Date}).then(function(e){I.nonce==e.data.nonce?m(e.data,!0):u.error("Probably a MITMA - Man in the middle Atack")},function(e){u.error(e)})}function m(e,t){I.cfg.session=e.token,I.cfg.user=e.username,t&&w.setItem("cfg",e)}function h(){function e(e,t){return n(I.cfg.URL.api+I.cfg.API_VERSION+"/"+e+"/",t)}function t(e,t){return n(I.cfg.URL.assets+I.cfg.API_VERSION+"/"+e,t)}function i(e,t){return n(I.cfg.URL.widget+"/"+I.cfg.API_VERSION+"/"+e+"/",t)}function n(e,t){return t?(e+=e.indexOf("?")>-1?"&":"?","string"==typeof t?e+t:e+o(t)):e}this.buildUrl=n,this.apiUrl=e,this.widgetUrl=i,this.assetsUrl=t}function v(e){return"undefined"==typeof e[0]?(u.error("Please specify Veridu 'client' on the  confguration phase of your application."),!1):!0}function S(){function e(e,t){return c.localStorage.setItem("veridu-"+e,JSON.stringify(t))}function t(e){return c.localStorage.removeItem("veridu-"+e)}function i(e){try{return JSON.parse(c.localStorage.getItem("veridu-"+e))}catch(t){return void c.localStorage.removeItem("veridu-"+e)}}this.setItem=e,this.removeItem=t,this.getItem=i}var I=this,w=new S;return this.nonce=w.getItem("nonce")||Math.round(1e8*Math.random()),I.user={},I.initialize=p,I.logout=f,I.Util=new h,I.API=new g,I.SSO=new d,I.Widget=new l,I.cfg={user:n,client:e,session:r,lang:t||"en-us",get API_VERSION(){return i||"0.3"},get URL(){return{api:"https://api.veridu.com/",widget:"https://widget.veridu.com",assets:"https://assets.veridu.com/"}}},p(),v(arguments)?void 0:this};return e.$get=["$http","$log","$httpParamSerializerJQLike","$window","$rootScope",function(t,i,n,r,o){return new e(this.client,this.lang,this.API_VERSION,this.user,this.session,n,t,i,r,o)}],e}),"object"==typeof e&&"object"==typeof e.exports?e.exports="veridu-angularjs-sdk":"function"==typeof define&&define.amd&&define([],function(){return"veridu-angularjs-sdk"})}();